!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.OpusToPCM=t()}(this,function(){"use strict";function e(e,t){var n=new Uint8Array((0|e.length)+(0|t.length));return n.set(e,0),n.set(t,0|e.length),n}var t=(function(){function e(e){this.value=e}function t(t){function n(e,t){return new Promise(function(n,r){var a={key:e,arg:t,resolve:n,reject:r,next:null};s?s=s.next=a:(o=s=a,i(e,t))})}function i(n,o){try{var s=t[n](o),a=s.value;a instanceof e?Promise.resolve(a.value).then(function(e){i("next",e)},function(e){i("throw",e)}):r(s.done?"return":"normal",s.value)}catch(e){r("throw",e)}}function r(e,t){switch(e){case"return":o.resolve({value:t,done:!0});break;case"throw":o.reject(t);break;default:o.resolve({value:t,done:!1})}o=o.next,o?i(o.key,o.arg):s=null}var o,s;this._invoke=n,"function"!=typeof t.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)}}(),function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}),n=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),i=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},o=function(){function e(n){t(this,e),this.listener={},this.type=""|n}return n(e,[{key:"on",value:function(e,t){return this.listener[e]||(this.listener[e]=[]),this.listener[e].push(t),!0}},{key:"off",value:function(e,t){if(this.listener[e]){var n=this.listener[e].indexOf(t);return n>-1&&this.listener[e].splice(n,1),!0}return!1}},{key:"offAll",value:function(){this.listener={}}},{key:"dispatch",value:function(e,t){return!!this.listener[e]&&(this.listener[e].map(function(e){e.apply(null,[t])}),!0)}}]),e}(),s=function(o){function s(e){t(this,s);var n=r(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,"ogg"));return n.channel=e,n.audioCtx=new AudioContext,n.queue=[],n.flushLimit=25,n.init(),n}return i(s,o),n(s,[{key:"getSampleRate",value:function(){return this.audioCtx.sampleRate}},{key:"init",value:function(){var t=void 0,n=void 0;this.oggHeader=new Uint8Array,this.pageIndex=0,this.serial=Math.ceil(Math.random()*Math.pow(2,32)),this.initChecksumTable(),t=this.getIDHeader(),n=this.getPage(t,2),this.oggHeader=e(this.oggHeader,n),t=this.getCommentHeader(),n=this.getPage(t,0),this.oggHeader=e(this.oggHeader,n)}},{key:"getIDHeader",value:function(){var e=new Uint8Array(19),t=new DataView(e.buffer);return t.setUint32(0,1937076303,!0),t.setUint32(4,1684104520,!0),t.setUint8(8,1,!0),t.setUint8(9,this.channel,!0),t.setUint16(10,0,!0),t.setUint32(12,8e3,!0),t.setUint16(16,0,!0),t.setUint8(18,0,!0),e}},{key:"getCommentHeader",value:function(){var e=new Uint8Array(20),t=new DataView(e.buffer);return t.setUint32(0,1937076303,!0),t.setUint32(4,1936154964,!0),t.setUint32(8,4,!0),t.setUint32(12,1633837924,!0),t.setUint32(16,0,!0),e}},{key:"getPage",value:function(e,t){var n=new Uint8Array(1),i=new Uint8Array(27+n.byteLength+e.byteLength),r=new DataView(i.buffer);return n[0]=e.length,r.setUint32(0,1399285583,!0),r.setUint8(4,0,!0),r.setUint8(5,t,!0),r.setUint32(6,-1,!0),r.setUint32(10,0,!0),r.setUint32(14,this.serial,!0),r.setUint32(18,this.pageIndex++,!0),r.setUint8(26,1,!0),i.set(n,27),i.set(e,28),r.setUint32(22,this.getChecksum(i),!0),i}},{key:"getOGG",value:function(){for(var t=this.oggHeader,n=void 0,i=void 0,r=void 0;this.queue.length;)n=this.queue.shift(),r=0==this.queue.length,i=this.getPage(n,r),t=e(t,i);return this.pageIndex=2,t}},{key:"getChecksum",value:function(e){for(var t=0,n=0;n<e.length;n++)t=t<<8^this.checksumTable[t>>>24&255^e[n]];return t>>>0}},{key:"initChecksumTable",value:function(){this.checksumTable=[];for(var e=0;e<256;e++){for(var t=e<<24,n=0;n<8;n++)t=0!=(2147483648&t)?t<<1^79764919:t<<1;this.checksumTable[e]=4294967295&t}}},{key:"decode",value:function(e){this.queue.push(e),this.queue.length>=this.flushLimit&&this.process()}},{key:"process",value:function(){var e=this,t=this.getOGG();this.audioCtx.decodeAudioData(t.buffer,function(t){e.dispatch("data",t)})}},{key:"getMergedPCMData",value:function(e){var t=void 0,n=[],i=void 0,r=void 0,o=0,s=0,a=0;for(s=0;s<this.channel;s++)t=e.getChannelData(s),n.push(t);for(i=n[0].length,r=new Float32Array(this.channel*i),s=0;i>s;){for(a=0;a<this.channel;a++)r[o++]=n[a][s];s++}return r}},{key:"destroy",value:function(){this.audioCtx.close(),this.oggHeader=null,this.audioCtx=null,this.checksumTable=null,this.offAll()}}]),s}(o);!function(e){function o(e,n){t(this,o);var i=r(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,"worker"));return i.worker=new Worker(n),i.worker.addEventListener("message",i.onMessage.bind(i)),i.worker.postMessage({type:"init",config:{rate:24e3,channels:e}}),i}i(o,e),n(o,[{key:"getSampleRate",value:function(){return 24e3}},{key:"decode",value:function(e){var t={type:"decode",buffer:e};this.worker.postMessage(t)}},{key:"onMessage",value:function(e){var t=e.data;this.dispatch("data",t.buffer)}},{key:"destroy",value:function(){this.worker=null,this.offAll()}}])}(o);return function(e){function o(e){t(this,o);var n=r(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,"decoder")),i={channels:1,fallback:!0,libopusPath:"libopus/opus.min.js"};return e=Object.assign({},i,e),n.decoder=new s(e.channels),n.decoder&&n.decoder.on("data",n.onData.bind(n)),n}return i(o,e),n(o,[{key:"getSampleRate",value:function(){return this.decoder.getSampleRate()}},{key:"onData",value:function(e){this.dispatch("decode",e)}},{key:"decode",value:function(e){if(!this.decoder)throw"opps! no decoder is found to decode";this.decoder.decode(e)}},{key:"destroy",value:function(){this.decoder.destroy(),this.offAll()}}]),o}(o)});
